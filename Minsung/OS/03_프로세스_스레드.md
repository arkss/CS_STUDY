# 03. 프로세스와 스레드

## 프로세스란

현대의 컴퓨터는 CPU가 여러 개의 코어를 가지고 있지만, 코어의 수가 1개라고 하더라도 동시에 여러 일을 할 수 있습니다.

이를 이해하기 위해서는 **프로세스**를 알아야합니다.

프로세스는 **운영체제로부터 자원을 할당받는 작업의 단위**입니다.

CPU는 한 순간에 오직 한 개의 프로세스를 실행하며 빠르게 다른 프로세스를 전환하여 병렬 작업을 가능케합니다.

이 때 하드웨어적인 병렬성과 구분하기 위해 이를 의사병렬성(pseudoparallelism)이라고 합니다.



## 프로세스의 구성요소

### 코드

프로그램의 코드 자체입니다.

프로그램이 실행되기 전에 주기억장치에 CPU가 해석할 수 있도록 바이너리 코드 상태로 저장합니다.

 CPU는 해당 코드를 한 줄씩 읽어가며 처리합니다.

### 데이터

프로그램의 전역 변수와 정적 변수가 저장되는 공간으로 프로세스와 같은 라이프사이클을 따릅니다.

 main 함수는 호출되기 전에 데이터 영역에 저장됩니다. 

### 스택

지역 변수와 함수 호출 시 전달되는 인수를 저장하는 공간입니다.

이렇게 스택 영역에 차례대로 저장되는 함수의 호출 정보를 스택 프레임(stack frame)이라고 합니다.

스택 프레임 내에서의 지역 변수에 대한 접근은 자유롭습니다.

### 힙

동적 할당되는 데이터를 저장하는 공간입니다.

스택보다 할당할 수 있는 메모리 공간이 많다는 것이 장점이지만 포인터로 메모리 영역을 접근해야 하기 때문에 다른 자료구조에 비해서 데이터를 읽고 쓰는게 느립니다.



## 프로세스의 생성

프로세스를 생성하는 이벤트를 알아봅시다.

### 1. 시스템 초기화

운영체제가 부팅할 때 init 프로세스가 생성됩니다.

이 때 수면 상태로 백그라운드에 머무르며 특정 이벤트 발생 시, 동작하는 프로세스를 **데몬**이라고 합니다.  



### 2. 실행 중인 프로세스가 프로세스 생성 시스템 호출

실행 중인 프로세스는 시스템 콜을 통해서 자신의 작업을 도와주는 프로세스들을 생성할 수 있습니다.

예를 들어 네트워크에서 많은 데이터를 가져와서 처리하는 경우를 생각해봅시다.

네트워크에서 공유 버퍼까지 기록하는 프로세스와, 공유 버퍼에서 가져와 처리하는 프로세스를 따로 두면 작업은 더 빨라질 것 입니다.



### 3. 사용자가 새로운 프로세스를 생성하도록 요청하는 경우

사용자가 명령어를 입력하거나 아이콘을 클릭하여 프로그램을 실행할 경우, 새로운 프로세스를 시작하고 프로세스는 선택한 프로그램을 실행합니다.



## 프로세스 종료

프로세스가 종료되는 경우를 알아봅시다.



### 1. 정상적인 종료

프로세스가 자신의 작업을 완료했기 때문에 종료합니다.



### 2. 오류 종료

프로세스에 의해 유발된 오류로 종료하는 경우입니다.

잘못된 명령어 실행, 존재하지 않는 메모리 접근, 0으로 나누기 등이 있습니다.



### 3. 치명적인 오류

프로세스가 치명적인 오류를 발견한 경우입니다.

사용자가 특정 파일을 읽기 위해 명령어를 입력했는데 특정 파일이 존재하지 않을 때 프로세스는 바로 종료합니다.



### 4. 다른 프로세스에 의해 종료

다른 프로세스가 운영체제에게 다른 프로세스를 종료시켜 줄 것을 요청하는 경우입니다.

UNIX에서 이러한 시스템 호출은 `kill` 입니다.



## 프로세스 제어 블록

**프로세스 제어 블록**은 프로세스 테이블이라고 부르기도 하며, process control block을 줄여 PCB라고 부르기도 합니다.

PCB는 각 프로세스마다 하나씩 존재하며 프로세스 상태에 대한 중요한 정보들을 저장하고 있습니다.

프로세스가 전환될 때 해당 정보들을 불러와 프로세스가 중단된 적이 없던 것 처럼 재시작할 수 있습니다.



저장되는 중요 정보들은 아래와 같습니다.

* 프로세스 ID
* 프로그램 카운터
* 스택 포인터
* 메모리 할당
* 스캐줄링 정보



## 스레드란

**스레드**는 **프로세스(프로그램)내에서 하나의 실행 단위**입니다.

스레드 개념이 없다면 어떻게 될까요?

우리가 자주 사용하는 엑셀을 예로 들어봅시다.

엑셀 내에서도 병렬적으로 처리해야할 작업이 많습니다.

사용자의 키보드 입력도 기다리며, 주기적으로 데이터를 백업하기도 하기도 해야합니다.

이렇게 하나의 프로그램 내에서 여러 스레드를 사용하여 병렬성을 확보할 수 있습니다.

여기서도 프로세스와 마찬가지로 유사병렬성입니다.



## 스레드가 필요한 이유

프로세스는 자신만의 분리된 주소 공간을 갖습니다.

그렇기 때문에 프로세스만을 사용하는 것은 때로 비효율적이고 부적합니다.



스레드는 한 프로세스 내에 주소 공간을 공유하여 더 효율적인 작업이 가능합니다.

또한 더 가볍기 때문에 생성과 제거가 10~200배 정도 쉽고 빠릅니다.

특히 많은 연산과 I/O 연산이 동시에 존재하면 더 큰 속도 향상을 볼 수 있습니다.





## 스레드 테이블

스레드는 일반적의 한 프로세스의 데이터들을 공유하지만 스레드 독자적으로 필요한 데이터도 존재합니다.



### 공유하는 데이터

* 주소공간
* 전역변수
* 자식 프로세스
* etc



### 독립적인 데이터

* 프로그램 카운터

  프로그램 카운터는 스레드의 명령을 어디까지 수행하였는지를 나타냅니다. 스레드 간의 스위칭이 일어나기 때문에 전환 시 어느 명령어까지 수행했는지 기억할 필요가 있습니다.

* 레지스터

* 스택

  스택은 함수 호출 시 전달되는 파라미터와 되돌아갈 주소값, 함수 내에서 선언하는 변수 등을 저장하기 위해 사용하는 메모리 공간입니다. 각 스레드 별로 스택을 별도로 가지게 되면 독립적으로 함수를 호출할 수 있고 이는 즉, 독립적인 실행 흐름을 가능하게 합니다.



## 멀티 프로세스와 멀티 스레드

### 멀티 프로세스

하나의 프로그램을 여러 개의 프로세스가 처리하는 것을 말합니다.



#### 장점

* 프로세스 간 영향이 적기 때문에 하나의 프로세스가 문제가 생겨 죽더라도 그 영향이 확산되지 않습니다.

#### 단점

* 프로세스 간 독립된 메모리 영역을 사용하기 때문에 context switching시 새로운 프로세스의 데이터를 새로 불러와야 하는데 이 때 오버헤드가 생깁니다.
* 프로세스 간의 통신, IPC가 어렵고 복잡합니다.



### 멀티 스레드

하나의 프로세스 내에서 여러 스레드가 작업을 처리하는 것을 말합니다.



#### 장점

* 한 프로세스 내에서 공유하는 자원들이 있기 때문에 context switching이 빠르고 간단합니다.
* 각 스레드 간의 통신의 부담이 적습니다.

#### 단점

* 자원을 공유하기 때문에 동기화 문제가 발생합니다.
* 하나의 스레드가 문제가 생기면 전체 프로세스가 영향을 받습니다.





## 레퍼런스

* 운영체제론
* https://gmlwjd9405.github.io/2018/09/14/process-vs-thread.html

## 질문할 사항

## 추가 공부할 키워드

* 프로세스간 통신
* 경쟁조건, 임계구역
* 다양한 상호배제 방법(뮤텍스, 세마포어 등등)

* 프로세스 스캐줄링