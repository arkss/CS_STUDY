# 06. 경쟁 조건, 임계 구역, 동기화



## 0. 운영체제에 대해서...

운영체제에 있어서 가장 중요한 두 가지를 꼽는다면

- CPU 스케줄링
- 프로세스 관리

라고 할 수 있습니다.





## 1. 프로세스/스레드 동기화

프로세스 동기화란 여러 프로세스가 **공유하는 자원의 일관성을 유지**하는 것입니다.
여러 프로세스가 동시에 하나의 공유된 자원에 접근하려고 할 때
이 프로세스들의 순서를 정하여 데이터의 일관성을 유지시켜줘야 합니다.



### 경쟁 상태

만일 두 개의 프로세스가 동시에 어떤 변수의 값을 바꿀 때
**프로세스의 접근 순서에 따라 결과 값이 달라질 수 있는 상황을 경쟁 상태(Race Condition)** 이라고 합니다.



### 은행 계좌 문제

동기화 문제 중에서 대표적인 경쟁 상태인 은행 계좌 문제 입니다.

가장 단순한 형태의 입출금 상황을 가정하겠습니다. 
은행에는 한 개의 계좌에 입금과 출금이 가능합니다.

**공유 자원** : 계좌

스레드 : 입금, 출금

자바로 작성된 코드는 [velog/@codemcd](https://velog.io/@codemcd/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9COS-8.-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EB%8F%99%EA%B8%B0%ED%99%94-1#:~:text=%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%20%EB%8F%99%EA%B8%B0%ED%99%94%EB%8A%94%20%EC%97%AC%EB%9F%AC%20%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4,%EC%9D%84%20%EC%9C%A0%EC%A7%80%EC%8B%9C%EC%BC%9C%EC%A3%BC%EC%96%B4%EC%95%BC%20%ED%95%9C%EB%8B%A4.) 블로그에 잘 나와있습니다.



동일한 양의 입출금이 일어난 이후 계좌 잔고가 0 이 아닌 값을 가지는 결과가 생깁니다.

이는 여러 스레드가 하나의 공유자원을 사용하는 동안 동기화 문제가 발생했기 때문입니다.



### 임계 구역

이런 경쟁 조건이 발생하지 않기 위해서는 한 번에 하나의 스레드만 메모리에 접근해야합니다.
이를 위해 임계 구역이라는 구역을 정의하게 됩니다.

> 여러 개의 스레드가 수행되는 시스템에서 각 쓰레드가 **공유하는 데이터(변수, 테이블, 파일 등)를 변경하는 코드 영역**

즉, 공유된 자원에 접근하기 위해선 임계 구역에 진입해야 합니다.

이러한 임계 구역 문제를 해결하기 위해선 3가지 조건을 충족해야 합니다.

- 상호 배제 (Mutual Exclusion)
  - 한 번에 2개 이상의 스레드가 접근할 수 없습니다.
- 진행 (Progress)
  - 임계영역에 어떤 스레드의 접근이 없을 때는 항상 접근이 가능합니다.
- 한정 대기 (Bounded waiting)
  - 자원을 요청한 스레드가 무한정 대기하지 않고 임계 구역으로 진입할 수 있습니다.





### 세마포어 (Semaphore)

공유된 자원의 데이터를 **여러 프로세스가** 접근하는 것을 막는 것입니다.

프로세스 간 상호배제와 동기화를 위한 연산이 필요하게 되고 세마포어는 여러 프로세스들에 의해 공유되는 변수로 정의됩니다.

자원에 접근할 수 없도록 블럭을 하고 
이 값이 0보다 크면 
접근함과 동시에 값을 1 감소시킵니다. 

반대로 종료하고 나갈 때에는 
세마포어의 값을 1 증가시켜 다른 프로세스가 접근할 수 있도록 합니다.



#### 세마포어 접근 함수 - wait(), signal()

세마포어 변수는 wait() 과 signal() 함수로만 접근 가능한 정수 타입의 변수입니다.

- wait() 
  - 세마포어 값을 감소시키고.
    이 값이 0 보다 작으면 임계구역에 프로세스가 이미 존재
  - 다른 프로세스는 접근할 수 없습니다.
- signal()
  - 세마포어값을 증가시키고,
    0보다 크거나 같으면 임계구역에 진입하려고 대기하는 프로세스가 존재
  - 그 중 하나를 임계구역을 수행할 수 있도록 해줄 수 있습니다.







### 뮤텍스

- 공유된 자원의 데이터를 **여러 스레드가** 접근하는 것을 막는 것
- 상호배제라고도 하며, Critical Section을 가진 스레드의 Running time이 서로 겹치지 않도록 각각 단독으로 실행하게 하는 기술이다.
- 다중 프로세스들의 공유 리소스에 대한 접근을 조율하기 위해 synchronized 또는 lock을 사용한다.
  - 즉, 뮤텍스 객체를 두 스레드가 동시에 사용할 수 없다.







## 레퍼런스

- https://velog.io/@codemcd/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9COS-8.-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EB%8F%99%EA%B8%B0%ED%99%94-1#:~:text=%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%20%EB%8F%99%EA%B8%B0%ED%99%94%EB%8A%94%20%EC%97%AC%EB%9F%AC%20%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4,%EC%9D%84%20%EC%9C%A0%EC%A7%80%EC%8B%9C%EC%BC%9C%EC%A3%BC%EC%96%B4%EC%95%BC%20%ED%95%9C%EB%8B%A4
- https://jhnyang.tistory.com/101
- http://www.kocw.net/home/search/kemView.do?kemId=978503

